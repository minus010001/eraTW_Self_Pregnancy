;*******************************************************************************************************
;路人子画像表示用
;*******************************************************************************************************
;削除しました＠v.4.730.INFO改良パッチ

;*******************************************************************************************************
;路人子画像生成用関数
;*******************************************************************************************************
@路人子生成(角色番号, 立絵種類)
#DIM 角色番号
#DIM 立絵種類
#DIM GID
#DIMS 生成文字列
#DIMS 合成文字列配列, 50
#DIMS 色合成
#DIM 合成数
#DIM リソースカウント

;別絵専用関数
IF STRFIND(CSTR:角色番号:路人子素材CSTR開始位置, "別絵描画") > -1
	CALL 別絵路人子画像生成(角色番号, 立絵種類)
	RETURN 1
ENDIF

;リソース作成
;=====================================
FOR リソースカウント, 0, 路人子素材リソース数
	;初期化
	GID = 0
	VARSET LOCAL
	VARSET 合成文字列配列,
	合成数 = 0
	;画像合成下地用のダミーを配置する
	CALL 画像合成(GID,"ダミー")
	;使用リソースの名称を配列に取得する
	;DEBUGPRINTFORML {角色番号} - 路人子リソース探索(%合成文字列配列%, {合成数}, %CSTR:角色番号:(路人子素材CSTR開始位置 + リソースカウント)%), 立絵種類
	CALL 路人子リソース探索(合成文字列配列, 合成数, CSTR:角色番号:(路人子素材CSTR開始位置 + リソースカウント), 立絵種類)
	;路人子画像は高い番号のリソースから先に合成していく必要があるので降順にソートする
	ARRAYSORT 合成文字列配列, BACK, 0, 合成数
	;路人子用画像を順番に合成していく
	FOR LOCAL, 0, 合成数
		色合成 '= ""
		IF 合成文字列配列:LOCAL != ""
			;色合成確認
			FOR LOCAL:1, 0 ,路人子素材色種別数
				IF STRFIND(合成文字列配列:LOCAL, @"_%路人子素材色種別:(LOCAL:1)%_") != -1 && DIC_CONTAINSKEY(CSTR:角色番号:(路人子素材CSTR開始位置 + リソースカウント), @"%路人子素材色種別:(LOCAL:1)%色")
					色合成 = %DIC_GET(CSTR:角色番号:(路人子素材CSTR開始位置 + リソースカウント), @"%路人子素材色種別:(LOCAL:1)%色")%
					LOCAL:1 = 路人子素材色種別数
				ENDIF
			NEXT
			CALL 画像合成(GID, 合成文字列配列:LOCAL, 0, 0, 0, 0, 色合成)
		ENDIF
	NEXT
	;合成した画像をリソースに登録する
	CFLAG:角色番号:(路人子素材CFLAG開始位置 + リソースカウント) = GID
	;汎用貂プレートで使用できるように名前を統一する
	IF !立絵種類
		SELECTCASE リソースカウント
			CASE 0
				CALL リソース登録(@"立絵_服_通常_{角色番号}", GID)
			CASE 1
				CALL リソース登録(@"立絵_服_笑顔_{角色番号}", GID)
			CASE 2
				CALL リソース登録(@"立絵_服_憤怒_{角色番号}", GID)
			CASE 3
				CALL リソース登録(@"立絵_裸_通常_{角色番号}", GID)
			CASE 4
				CALL リソース登録(@"立絵_裸_笑顔_{角色番号}", GID)
			CASE 5
				CALL リソース登録(@"立絵_裸_憤怒_{角色番号}", GID)
		ENDSELECT
	ELSE
		SELECTCASE リソースカウント
			CASE 0
				CALL リソース登録(@"顔絵_服_通常_{角色番号}", GID)
			CASE 1
				CALL リソース登録(@"顔絵_服_笑顔_{角色番号}", GID)
			CASE 2
				CALL リソース登録(@"顔絵_服_憤怒_{角色番号}", GID)
			CASE 3
				CALL リソース登録(@"顔絵_裸_通常_{角色番号}", GID)
			CASE 4
				CALL リソース登録(@"顔絵_裸_笑顔_{角色番号}", GID)
			CASE 5
				CALL リソース登録(@"顔絵_裸_憤怒_{角色番号}", GID)
		ENDSELECT
	ENDIF
NEXT

;TEQUIP:角色番号:上半身着衣状況 = 1

RETURN 1

;*******************************************************************************************************
;路人子画像リソース探索用関数
;路人子画像のリソースを探索して配列にリソース名を格納する
;*******************************************************************************************************
@路人子リソース探索(合成文字列配列, 合成数, 生成文字列, 立絵種類)
#DIMS REF 合成文字列配列,0
#DIM REF 合成数
#DIMS 生成文字列
#DIM 立絵種類
#DIMS キー
#DIM CN_ENDNO = 18
#DIMS CN_NO_STR
VARSET LOCAL
キー =
CN_NO_STR =
;ゴミ取り
生成文字列 = %REPLACE(生成文字列, "^\"\"", "")%
;DEBUGPRINTFORML %生成文字列%

FOR LOCAL, 0, 路人子素材種別数
	IF DIC_CONTAINSKEY(生成文字列, 路人子素材種別:LOCAL)
		FOR LOCAL:1, CN_ENDNO, -1, -1
			;IF STRFIND(路人子素材種別:LOCAL, "装飾") != -1
				;装飾の場合は複数設定できるのでリソース名検索時は数値部分を削る
			;	キー = "装飾"
			;ELSE
				キー = %路人子素材種別:LOCAL%
			;ENDIF
			FOR LOCAL:2, 0, 路人子素材カテゴリ数
				IF LOCAL:1 < 10
					;0埋め
					CN_NO_STR = CN0{LOCAL:1}
				ELSE
					CN_NO_STR = CN{LOCAL:1}
				ENDIF
				IF SPRITECREATED(@"%CN_NO_STR%_%路人子素材カテゴリ:(LOCAL:2)%_%DIC_GET(生成文字列, キー)%")
					IF (!立絵種類)
						合成文字列配列:(合成数++) = %CN_NO_STR%_%路人子素材カテゴリ:(LOCAL:2)%_%DIC_GET(生成文字列, キー)%
						DEBUGPRINTFORML %CN_NO_STR%_%路人子素材カテゴリ:(LOCAL:2)%_%DIC_GET(生成文字列, キー)%
					ELSE
						合成文字列配列:(合成数++) = %CN_NO_STR%_%路人子素材カテゴリ:(LOCAL:2)%_%DIC_GET(生成文字列, キー)%_顔
						DEBUGPRINTFORML %CN_NO_STR%_%路人子素材カテゴリ:(LOCAL:2)%_%DIC_GET(生成文字列, キー)%_顔
					ENDIF
				ENDIF
			NEXT
		NEXT
	ENDIF
NEXT

RETURN 1

;*******************************************************************************************************
;路人子画像解放用関数
;指定した角色番号の路人子のグラフィックを全て破棄する
;*******************************************************************************************************
@路人子画像リセット(角色番号)
#DIM 角色番号
#DIM リソースカウント
IF CFLAG:角色番号:路人子素材CFLAG開始位置 != 0 && GCREATED(CFLAG:角色番号:路人子素材CFLAG開始位置)
	SPRITEDISPOSE @"立絵_服_通常_{角色番号}"
	SPRITEDISPOSE @"立絵_服_笑顔_{角色番号}"
	SPRITEDISPOSE @"立絵_服_憤怒_{角色番号}"
	SPRITEDISPOSE @"立絵_裸_通常_{角色番号}"
	SPRITEDISPOSE @"立絵_裸_笑顔_{角色番号}"
	SPRITEDISPOSE @"立絵_裸_憤怒_{角色番号}"
	SPRITEDISPOSE @"顔絵_服_通常_{角色番号}"
	SPRITEDISPOSE @"顔絵_服_笑顔_{角色番号}"
	SPRITEDISPOSE @"顔絵_服_憤怒_{角色番号}"
	SPRITEDISPOSE @"顔絵_裸_通常_{角色番号}"
	SPRITEDISPOSE @"顔絵_裸_笑顔_{角色番号}"
	SPRITEDISPOSE @"顔絵_裸_憤怒_{角色番号}"
	FOR リソースカウント, 0, 路人子素材リソース数
		GDISPOSE CFLAG:角色番号:(路人子素材CFLAG開始位置 + リソースカウント)
		CFLAG:角色番号:(路人子素材CFLAG開始位置 + リソースカウント) = 0
	NEXT
ENDIF
RETURN 1
